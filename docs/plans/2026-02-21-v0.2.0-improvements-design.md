# Claude Manager v0.2.0 — Improvements Design

**Date**: 2026-02-21
**Scope**: Bug fix (navigation lag), process management, UI overhaul, auto-updater, app icon

---

## 1. Navigation Lag Fix

### Problem

Every up/down key press calls `update_selected_details()` which spawns 4-5 blocking git subprocess calls (branch, status --porcelain, rev-list x2). This causes visible delay when navigating the project list.

### Solution: Background Worker Thread + Cache

**Architecture**:

```
Main Thread                    Worker Thread
    │                              │
    ├─ user presses ↓/↑           │
    ├─ show cached data instantly  │
    ├─ send(project_path) ────────►│
    │                              ├─ git branch
    │                              ├─ git status --porcelain
    │                              ├─ git rev-list (ahead)
    │                              ├─ git rev-list (behind)
    │                              ├─ send(result) back
    │◄─────────────────────────────┤
    ├─ update cache + redraw       │
```

**New module**: `git_worker.rs`
- Spawns a persistent background thread on app init
- Exposes `request_status(path: String)` to queue work
- Uses `mpsc::channel` for bidirectional communication
- Main thread polls `try_recv()` in the 100ms event loop tick

**Cache**: `HashMap<String, (Instant, GitStatusInfo)>`
- Entries valid for 30 seconds
- Force-refreshable with `Enter` or `F5`
- `Path::exists()` calls in `render_project_list` also cached (checked once on load, refreshed on `F5`)

**Changes to `app.rs`**:
- `update_selected_details()` becomes non-blocking: reads cache, sends background request
- Event loop tick checks for completed background results and triggers redraw
- Navigation is instant regardless of git repo size

---

## 2. Stop Kills Everything (Port + Claude Terminal)

### Problem

Pressing `x` only kills the dev server child process. The Claude terminal window stays open and the port may linger.

### Solution: Track Both Processes in ProcessManager

**New data structure**:

```rust
struct ManagedProject {
    dev_server: Option<Child>,      // dev server process
    claude_pid: Option<u32>,        // Claude terminal PID
    port: Option<u16>,              // assigned port
    output: Arc<Mutex<CircularBuffer>>,
}
```

**Stop sequence** (on `x` keypress):
1. Kill dev server `Child` (existing behavior)
2. Kill Claude terminal by PID:
   - Windows: `taskkill /PID {pid} /T /F` (kills entire process tree)
   - Unix: `kill -TERM -{pgid}` (kill process group), fallback to `kill -9`
3. Verify port freed: poll `is_port_open(port)` every 200ms for up to 2 seconds
4. Clear output buffer and remove from HashMap

**Launch changes**:
- `spawn_terminal()` returns `Option<u32>` (the PID)
- PID stored in `ManagedProject.claude_pid`
- On Windows, `Command::spawn()` provides the PID directly

---

## 3. UI Overhaul — Modern Dark Theme with Status Colors

### Color Palette

New module: `theme.rs` with centralized color constants.

| Constant | Color | Use |
|----------|-------|-----|
| `BG` | Terminal default | Background |
| `FG` | `Gray` | Default text |
| `FG_DIM` | `DarkGray` | Secondary text, help bar |
| `ACCENT` | `Cyan` | Borders, titles, highlights |
| `STATUS_RUNNING` | `Green` | Running indicator |
| `STATUS_STOPPED` | `DarkGray` | Stopped/idle indicator |
| `STATUS_PORT` | `Cyan` | Port badge |
| `GIT_DIRTY` | `Yellow` | Uncommitted changes |
| `GIT_AHEAD` | `Yellow` | Commits ahead |
| `GIT_BEHIND` | `Red` | Commits behind |
| `GIT_CLEAN` | `Green` | Clean working tree |
| `BORDER_ACTIVE` | `Cyan` | Active panel border |
| `BORDER_INACTIVE` | `DarkGray` | Inactive panel border |
| `DANGER` | `Red` | Delete, errors |
| `WARNING` | `Yellow` | Warnings, quit confirm |

### Project List Item Format

```
 ● my-web-app              :3000
 ○ claude-manager
 ● api-server              :8080
 ○ old-project             [!]
```

- `●` green = running, `○` dim = stopped
- `:3000` cyan = active port
- `[!]` yellow = dirty working tree

### Detail Panel

```
┌─ Project Details ──────────────────────┐
│  Name      my-web-app                  │
│  Path      ~/Projects/my-web-app       │
│  Type      JavaScript (pnpm)           │
│                                        │
│  ── Git ──                             │
│  Branch    main                        │
│  Status    ✓ clean                     │
│  Ahead     0    Behind  2              │
│                                        │
│  ── Runtime ──                         │
│  Status    ● Running                   │
│  Port      3000                        │
│  Command   pnpm run dev               │
└────────────────────────────────────────┘
```

- Section headers (Git, Runtime) in accent color
- Labels in dim, values in default
- Status values colored by state

### Bottom Status Bar

```
 2 running │ ports: 3000, 8080 │ v0.2.0          [q]uit [r]un [x]stop [a]dd
```

---

## 4. Auto-Updater

### Architecture: Background Check on Launch + Modal Prompt

**Startup flow**:
1. App initializes normally (no blocking)
2. Background thread: `GET https://api.github.com/repos/stephenfjohnson/claude-manager/releases/latest`
   - Uses `curl -s` (Unix/macOS) or `curl.exe -s` (Windows 10+ ships with curl)
   - Parses JSON for `tag_name` and asset download URLs
3. Compare `tag_name` (strip `v` prefix) against `env!("CARGO_PKG_VERSION")`
4. If newer: set `app.update_available = Some(UpdateInfo { version, download_url })`
5. Render notification bar: `"Update available: v0.3.0 — press [u] to update"`
6. On `u`: download binary, replace executable, show restart message

**Self-update mechanism**:
- Download to temp file (`{exe_dir}/claude-manager.new`)
- Unix: `rename(new, current)` (atomic)
- Windows: `rename(current, current.old)` then `rename(new, current)`, clean up `.old` on next launch

**New module**: `updater.rs` (~100-150 lines)
**No new dependencies**: uses `curl` via subprocess + manual JSON parsing (matching existing `gh.rs` pattern)

---

## 5. Application Icon

### Icon Design

Terminal prompt symbol `>_` in a rounded-corner square, cyan/teal on dark background.

### Files

- `assets/icon.ico` — Windows (multi-size: 16/32/48/256px)
- `assets/icon.icns` — macOS
- `assets/icon.png` — Linux (256x256)

### Build Integration

**Windows**: `build.rs` using `winres` crate to embed `.ico` into the `.exe`
- New build dependency: `winres = "0.1"` (build-only, Windows-only)

**macOS**: Release workflow wraps binary in `.app` bundle with `.icns`

**Linux**: Release tarball includes `.desktop` file + PNG icon

### New Files

- `build.rs` — conditional Windows resource compilation
- `assets/` directory with icon files in all formats

---

## Summary of New/Modified Files

| File | Action | Purpose |
|------|--------|---------|
| `src/git_worker.rs` | New | Background git status thread + cache |
| `src/theme.rs` | New | Centralized color palette constants |
| `src/updater.rs` | New | Auto-update check + download |
| `src/app.rs` | Modify | Non-blocking navigation, new UI rendering, update notification, stop-all |
| `src/process.rs` | Modify | Track Claude terminal PIDs, port verification on stop |
| `src/main.rs` | Modify | Initialize git worker, start update check |
| `src/tui.rs` | Modify | Poll git worker results in event loop |
| `build.rs` | New | Windows icon embedding |
| `assets/icon.*` | New | Icon files (ico, icns, png) |
| `Cargo.toml` | Modify | Add winres build-dep, bump version to 0.2.0 |
| `.github/workflows/release.yml` | Modify | macOS .app bundle, Linux .desktop file |

## New Dependencies

- `winres = "0.1"` (build-only, Windows target only)

No runtime dependencies added.
